---
title: 示例
date: 2026-01-29 13:55:04
tags: [示例, 嵌入式]
---

# 嵌入式系统实例代码

> RT-Thread 电池管理系统 - 主控板、ADC 采集、LCD 显示、遥控按键

---

## 目录

1. [ADC 频率采集模块](#1-adc-频率采集模块)
2. [遥控按键模块](#2-遥控按键模块)
3. [TJC 显示屏模块](#3-tjc-显示屏模块)
4. [主控板模块](#4-主控板模块)

---

## 1. ADC 频率采集模块

### 1.1 头文件与宏定义

```c
#include "adc_frequence.h"
#include <rtthread.h>
#include "board.h"

#define DBG_TAG "FREQ"
#define DBG_LVL DBG_LOG
#include <rtdbg.h>
```

### 1.2 ADC 采集设置

```c
/***********************ADC 采集设置*************************************/
#define SAMPLE_HANDLE_PERIOD    1000    //两秒处理一次数据
#define PERIOD_SAMPLE_COUNT       80      //一个周期80个点
#define AD_SAMPLE_COUNT           160     //采集2个周期
#define AD_SAMPLE_CHANNEL_COUNT   2

uint16_t SampleCount = 0;                                       //记录采样次数
uint16_t PeriodADCSampleBuff[AD_SAMPLE_CHANNEL_COUNT][AD_SAMPLE_COUNT] = { 0 };          //adc采样的数据
uint16_t PeriodTempBuff[AD_SAMPLE_CHANNEL_COUNT][AD_SAMPLE_COUNT] = { 0 };               //adc 暂存的数据
uint16_t PeriodTempBuff2[AD_SAMPLE_COUNT] = {0};
uint16_t PeriodDMABuff[AD_SAMPLE_CHANNEL_COUNT] = {0};          //DMA 数据暂存地址

ADC_HandleTypeDef PeriodADC;
DMA_HandleTypeDef PeriodADCDMA;
#define FREQUENCY_ADC_INSTANCE            ADC1
#define FREQUENCY_ADC_CHANNEL1            ADC_CHANNEL_0
#define FREQUENCY_ADC_CHANNEL2            ADC_CHANNEL_6

#define ADC_CURRENT_GPIOX               GPIOA
#define ADC_CURRENT_PIN                 GPIO_PIN_0

#define ADC_VOLTAGE_GPIOX               GPIOA
#define ADC_VOLTAGE_PIN                 GPIO_PIN_6

rt_tick_t   SampleConsumeTick = 0;
```

### 1.3 定时器频率设置

```c
/****************************定时器频率设置********************************************/
TIM_HandleTypeDef htim3;
#define TIM3_PRESCALER      72      //72分频， 定时器时钟频率1MHz,1us
#define TIM3_PERIOD_DEFALT  250     //定时器定时时间为250us, 为一个频率为50Hz的信号，采集80次信号
```

### 1.4 ADC DMA 初始化

```c
/******************************************************************************************************/
void frequency_adc_dma_init(void)
{
    /* Peripheral clock enable */
    __HAL_RCC_ADC1_CLK_ENABLE();
    /* ADC1 DMA Init */
    /* ADC1 Init */
    PeriodADCDMA.Instance = DMA1_Channel1;
    PeriodADCDMA.Init.Direction = DMA_PERIPH_TO_MEMORY;
    PeriodADCDMA.Init.PeriphInc = DMA_PINC_DISABLE;
    PeriodADCDMA.Init.MemInc = DMA_MINC_ENABLE;
    PeriodADCDMA.Init.PeriphDataAlignment = DMA_PDATAALIGN_HALFWORD;
    PeriodADCDMA.Init.MemDataAlignment = DMA_MDATAALIGN_HALFWORD;
    PeriodADCDMA.Init.Mode = DMA_NORMAL;
    PeriodADCDMA.Init.Priority = DMA_PRIORITY_MEDIUM;
    if (HAL_DMA_Init(&PeriodADCDMA) != HAL_OK)
    {
        RT_ASSERT(RT_FALSE);
    }

    __HAL_LINKDMA(&PeriodADC, DMA_Handle, PeriodADCDMA);
}
```

### 1.5 ADC 初始化与采样处理

```c
void frequency_adc_init(void)
{
    /* 使能DMA中断传输 */
    __HAL_RCC_DMA1_CLK_ENABLE();
    /* ... 省略详细实现 ... */
}

uint16_t dong_get_adc()
{
    uint16_t Result = 0;
    HAL_ADC_Stop_DMA(&PeriodADC);
    PeriodADCSampleBuff[AD_CURRENT_CHANNEL_RANK][SampleCount] = PeriodDMABuff[AD_CURRENT_CHANNEL_RANK];
    PeriodADCSampleBuff[AD_VOLTAGE_CHANNEL_RANK][SampleCount] = PeriodDMABuff[AD_VOLTAGE_CHANNEL_RANK];
    SampleCount++;
    HAL_ADC_Start_DMA(&PeriodADC, (uint32_t*)&PeriodDMABuff, (AD_SAMPLE_CHANNEL_COUNT));
    return Result;
}
```

### 1.6 信号处理算法

| 函数名 | 功能说明 |
|--------|----------|
| `periodic_sortArray` | 冒泡排序 |
| `square_Root_float` | 浮点数开根号（快速平方根算法） |
| `gaussian_filter` | 高斯滤波 |
| `sampling_signal_process2` | 以均值为基准的采样信号处理 |

---

## 2. 遥控按键模块

### 2.1 引脚配置

```c
#include "remote_key.h"
#include "global_var.h"
#include "drv_pin.h"

rt_tick_t KeyTick = 0;
/***********************************遥控引脚配置 开始 *****************************/
struct KEY_GPIO_config{
    char *Name;             //引脚名
    uint32_t Mode;          //模式配置
};
const struct KEY_GPIO_config KeyGPIOConfig[] = {
        {KEY_FUNC, GPIO_MODE_IT_RISING_FALLING},
        {KEY_S1, GPIO_MODE_IT_RISING_FALLING},
        {KEY_S2, GPIO_MODE_IT_RISING_FALLING},
        {KEY_ADD, GPIO_MODE_IT_RISING_FALLING},
        {KEY_DEL, GPIO_MODE_IT_RISING_FALLING},
};

#define KEY_DETCET_INTERVAL 250
```

### 2.2 中断服务函数

- **EXTI9_5_IRQHandler**：处理 KEY_DEL、KEY_ADD 按键
- **EXTI15_10_IRQHandler**：处理 KEY_FUNC、KEY_S1、KEY_S2 按键

---

## 3. TJC 显示屏模块

### 3.1 设备结构体

```c
typedef struct
{
    rt_device_t Device;
    uint8_t rx_ind;         //接收标志

    void (* show_background)(void *parameter);
    void (* update_page)(void *parameter);
    void (* function_key)(void *parameter);
    void (* add_key)(void *parameter);
    void (* del_key)(void *parameter);
    void (* s1_key)(void *parameter);
    void (* s2_key)(void *parameter);

    uint8_t LCDCurrentPage;        //LCD 当前页面
    uint8_t LCDPageSwitchFlag;     //是否进行切换操作

}LCD_Device_t;
```

### 3.2 页面类型枚举

```c
typedef enum
{
    LCD_BATTERY_INFO_PAGE = 0x00,      // 电池信息界面
    LCD_BATTERY_SINGLE_INFO_PAGE,      // 单体电池信息
    LCD_ALARM_INFO_PAGE1,              // 报警信息界面1
    LCD_ALARM_INFO_PAGE2,              // 报警信息界面2
    LCD_OUTPUT_CONTROL_PAGE,           // 输出控制界面
    LCD_MENU_PAGE,                     // 菜单界面
    LCD_ALL_PAGE
}LCDPage_e;
```

### 3.3 主要功能

| 功能 | 说明 |
|------|------|
| `update_screen_data_from_BMS` | 从 BMS 更新电池数据 |
| `update_screen_data_from_control` | 从主控更新数据 |
| `lcd_page_switch` | 页面切换 |
| `__update_handle` | 界面显示刷新 |
| `__key_event_handle` | 按键事件处理 |

---

## 4. 主控板模块

### 4.1 GPIO 配置

```c
struct GPIO_config
{
    char *Name;             //引脚名
    uint32_t Mode;          //模式配置
};
const struct GPIO_config GPIOConfig[] = {
    { AC_CONTROPL, GPIO_MODE_OUTPUT_PP },
    { CHARGING_CONTROL, GPIO_MODE_OUTPUT_PP },
    { BATTERY_CONTROL, GPIO_MODE_OUTPUT_PP },
    { MODBUS_RS485_CONTROL, GPIO_MODE_OUTPUT_PP },
    { BMS_RS485_CONTROL, GPIO_MODE_OUTPUT_PP },
    { AC_SWITCH,  GPIO_MODE_IT_RISING_FALLING },
    { AC_DETECTION, GPIO_MODE_IT_RISING_FALLING },
    // ... 更多引脚
};
```

### 4.2 控制状态机结构

```c
struct ControlSTM_t
{
    Battery_STM_Flag_e BatteySTM;    //电池状态机
    uint32_t BATAbnormalFlag;        //异常状态标志位
    uint8_t BATSwitchFlag;           //电池状态发生切换标志
    rt_tick_t BATChargeDelayTick;    //充电过流延迟
    rt_tick_t BATOverchargeTick;
    uint8_t BATOverchargeCount;
    // ... 更多字段
};
```

### 4.3 电池状态机枚举（部分）

| 状态 | 说明 |
|------|------|
| `BATTERY_STM_CHARGING` | 充电状态 |
| `BATTERY_STM_DISCHARGING` | 放电状态 |
| `BATTERY_STM_MAINTAINFUNCTION` | 维护功能 |
| `BATTERY_STM_OVERCHARGING` | 充电过流 |
| `BATTERY_STM_OVERDISCHARGING` | 放电过流 |
| `BATTERY_STM_LOW_TEMP` | 低温异常 |
| `BATTERY_STM_OVER_TEMP` | 高温异常 |

### 4.4 主要处理流程

```
main_control_thread_entry()
    ├── __init_control_STM()           // 初始化状态机
    ├── __init_control_board_gpio()    // 初始化 GPIO
    ├── __init_AC_frequency_detect()  // 交流频率检测
    ├── init_periodic_signal_sample() // 周期信号采样
    └── while(1)
            └── control_STM_process()
                    ├── exti_STM_process()      // 外部中断处理
                    ├── battery_STM_process()  // 电池状态处理
                    ├── power_surply_process() // 供电处理
                    └── AC_sample_process()    // 交流采样
```

### 4.5 ADC 与 TIM 配置

- **ADC**：采集电池充放电电流、交流电流、输出电压
- **TIM2**：PWM 输入检测，用于交流频率测量
- **TIM3**：周期采样定时触发

---

